name: üöÄ Deploy Hoja de Vida

on:
  push:
    branches: [ main ]
    paths:
      - 'public/**'
      - 'Dockerfile'
      - 'server.js'
      - '.github/workflows/deploy-cv.yml'

jobs:
  deploy-cv:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-2

    - name: Deploy via SSM
      run: |
        echo "üöÄ Enviando comando SSM a la instancia..."

        COMMAND_ID=$(aws ssm send-command \
          --instance-ids i-011bf71bc93de5466 \
          --document-name "AWS-RunShellScript" \
          --comment "Deploy CV APP" \
          --parameters "commands=[
            'export HOME=/home/ec2-user',
            'git config --global --add safe.directory /home/ec2-user/cv-app/Jikkosoft',

            'cd /home/ec2-user/cv-app',
            'rm -rf Jikkosoft',
            'git clone https://github.com/santiagoartgut9/Jikkosoft-trabajo.git Jikkosoft',

            'cd Jikkosoft',
            'docker build -t jikkosoft-cv-app . --no-cache',
            'docker stop cv-app || true',
            'docker rm cv-app || true',

            'docker run -d --name cv-app \
              --log-driver=awslogs \
              --log-opt awslogs-region=us-east-2 \
              --log-opt awslogs-group=jikkosoft-app-logs \
              --log-opt awslogs-stream=$(hostname)-cv-app \
              -p 80:3000 jikkosoft-cv-app'
          ]" \
          --query "Command.CommandId" \
          --output text \
          --region us-east-2)

        echo "CommandId: $COMMAND_ID"

        echo "‚è≥ Esperando ejecuci√≥n del comando..."
        sleep 20

        STATUS=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id i-011bf71bc93de5466 \
          --query "Status" \
          --output text \
          --region us-east-2)

        echo "Estado final del comando: $STATUS"

        if [ "$STATUS" != "Success" ]; then
          echo "‚ùå El comando fall√≥"
          exit 1
        fi
